<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="A tool to help Runescape item flippers.">
    <meta name="author" content="Ectropy">
    <link rel="icon" href="favicon.ico">

    <title>Invert - Runescape Flipping Tool</title>

    <!-- Bootstrap core CSS -->
    <link href="bootstrap-3.3.6-dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <link href="bootstrap-3.3.6-dist/css/ie10-viewport-bug-workaround.css" rel="stylesheet">

    <!-- Selectize imports -->
    <link href="selectize.js-master-0.12.1/dist/css/selectize.bootstrap3.css" rel="stylesheet">

    <style type="text/css">
        body {
            padding-top: 75px;
        }
        .flipTable td{
            height: 40px;
        }
        .archived{ /* By default the archived flips are hidden */
            display: none;
        }
        
    </style>

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body>

    <nav class="navbar navbar-inverse navbar-fixed-top">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="#">Invert</a>
            </div>
            <div id="navbar" class="collapse navbar-collapse">
                <ul class="nav navbar-nav">
                    <li class="active"><a href="#">Home</a></li>
                </ul>
            </div>
            <!--/.nav-collapse -->
        </div>
    </nav>

    <div class="container">


        <div class="row">
            <div class="col-md-12">
                <h1>Invert</h1>
                <p>Invert is a tool that helps you keep track of item flips. For your convenience, it is set up to use Flipchat1's standard list of items, but you can always enter a custom item if you're flipping an item that Flipchat1 doesn't price check.</p>
                <p>Click <a href="http://www.flipchat1rs.com/t1104-flipchat1-starters-guide-english-version">here</a> to see more info about the basics of flipping with Flipchat1, and gain a better understanding of the concepts that this tool is based on.</p>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6">
                <h2>Add New Flip</h2>
                <form id="newFlipForm" class="form-horizontal">
                    <div class="form-group">
                        <label for="itemName" class="col-sm-4 control-label">Name</label>
                        <div class="col-sm-8">
                            <select name="itemName" id="itemName" class="form-control">
                                <option value="">Select or type the name of an item</option>
<!--                                <optgroup abel="BLINE - Bandos Line">-->
                                    <option value="bh" data-limit="1/4">BH - Bandos Helmet</option>
                                    <option value="bcp" data-limit="1/4">BCP - Bandos Chestplate</option>
                                    <option value="tass" data-limit="1/4">TASS - Bandos Tassets</option>
                                    <option value="bg" data-limit="1/4">BG - Bandos Gloves</option>
                                    <option value="bb" data-limit="1/4">BB - Bandos Boots</option>
                                    <option value="bws" data-limit="1/4">BWS - Bandos Warshield</option>
<!--                                </optgroup>-->

<!--                                <optgroup label="ALINE - Armadyl Line">-->
                                    <option value="ah" data-limit="1/4">AH - Armadyl Helmet</option>
                                    <option value="acp" data-limit="1/4">ACP - Armadyl Chestplate</option>
                                    <option value="acs" data-limit="1/4">ACS - Armadyl Chainskirt</option>
                                    <option value="ag" data-limit="1/4">AG - Armadyl Gloves</option>
                                    <option value="ab" data-limit="1/4">AB - Armadyl Boots</option>
                                    <option value="acb" data-limit="1/4">ACB - Armadyl Crossbow</option>
                                    <option value="oacb" data-limit="1/4">OACB - Off-Hand Armadyl Crossbow</option>
                                    <option value="buck" data-limit="1/4">BUCK - Armadyl Buckler</option>
<!--                                </optgroup>-->

<!--                                <optgroup label="SLINE - Subjugation Line">-->
                                    <option value="sh" data-limit="1/4">SH - Hood of Subjugation</option>
                                    <option value="garb" data-limit="1/4">GARB - Garb of Subjugation</option>
                                    <option value="gown" data-limit="1/4">GOWN - Gown of Subjugation</option>
                                    <option value="sg" data-limit="1/4">SG - Gloves of Subjugation</option>
                                    <option value="sb" data-limit="1/4">SB - Boots of Subjugation</option>
                                    <option value="ward" data-limit="1/4">WARD - Ward of Subjugation</option>
<!--                                </optgroup>-->

<!--                                <optgroup label="T LINE - Tetsu Line">-->
                                    <option value="tth" data-limit="2/4">TTH - Tetsu Helm</option>
                                    <option value="ttb" data-limit="2/4">TTB - Tetsu Body</option>
                                    <option value="ttl" data-limit="2/4">TTL - Tetsu Legs</option>
<!--                                </optgroup>-->

<!--                                <optgroup label="DL LINE - Death Lotus Line">-->
                                    <option value="blh" data-limit="2/4">DLH - Death Lotus Hood</option>
                                    <option value="dlcp" data-limit="2/4">DLCP - Death Lotus Chestplate</option>
                                    <option value="dlc" data-limit="2/4">DLC - Death Lotus Chaps</option>
<!--                                </optgroup>-->

<!--                                <optgroup label="SS LINE - Seasinger's Line">-->
                                    <option value="ssh" data-limit="2/4">SSH - Seasinger's Hood</option>
                                    <option value="sst" data-limit="2/4">SST - Seasinger's Robe Top</option>
                                    <option value="ssb" data-limit="2/4">SSB - Seasinger's Robe Bottom</option>
<!--                                </optgroup>-->

<!--                                <optgroup label="AMULETS - Amulets Line">-->
                                    <option value="hiss" data-limit="1/4">HISS - Saradomin's Hiss</option>
                                    <option value="murm" data-limit="1/4">MURM - Saradomin's Murmur</option>
                                    <option value="whisp" data-limit="1/4">WHISP - Saradomin's Whisper</option>
<!--                                </optgroup>-->

<!--                                <optgroup label="MISC LINE - Miscellaneous Line">-->
                                    <option value="sss" data-limit="1/4">SSS/SPEC - Spectral Spirit Shield</option>
                                    <option value="rhh" data-limit="2/4">RHH - Robin Hood Hat</option>
                                    <option value="rb" data-limit="2/4">RB - Ranger Boots</option>
                                    <option value="blood" data-limit="2/4">BLOOD - Blood Necklace Shard</option>
<!--                                </optgroup>-->

<!--                                <optgroup label="KITES - Kites Line">-->
                                    <option value="male" data-limit="1/4">MALE - Malevolent Kiteshield</option>
                                    <option value="merc" data-limit="1/4">MERC - Merciless Kiteshield</option>
                                    <option value="veng" data-limit="1/4">VENG - Vengeful Kiteshield</option>
<!--                                </optgroup>-->
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="buyFor" class="col-sm-4 control-label">Buy For</label>
                        <div class="col-sm-8">
                            <div class="input-group">
                                <input type="text" class="form-control" id="buyFor">
                                <div class="input-group-addon">gp</div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="sellFor" class="col-sm-4 control-label">Sell For</label>
                        <div class="col-sm-8">
                            <div class="input-group">
                                <input type="text" class="form-control" id="sellFor">
                                <div class="input-group-addon">gp</div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-4 control-label">Profit Per Item</label>
                        <div class="col-sm-8">
                            <p class="form-control-static" id="profit">0 gp</p>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="quantity" class="col-sm-4 control-label">Quantity</label>
                        <div class="col-sm-4">
                            <input type="text" class="form-control" id="quantity">
                        </div>
                        <div class="col-sm-4">
                            <p class="form-control-static" id="purchaseLimit">Purchase Limit: Unknown</p>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="cost" class="col-sm-4 control-label">Total Cost</label>
                        <div class="col-sm-8">
                            <p class="form-control-static" id="cost">0 gp</p>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="revenue" class="col-sm-4 control-label">Total Revenue</label>
                        <div class="col-sm-8">
                            <p class="form-control-static" id="revenue">0 gp</p>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="totalProfit" class="col-sm-4 control-label">Total Profit</label>
                        <div class="col-sm-8">
                            <p class="form-control-static" id="totalProfit">0 gp</p>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="timerDuration" class="col-sm-4 control-label">Timer Duration</label>
                        <div class="col-sm-8">
                            <div class="input-group">
                            <input type="text" class="form-control" id="timerDuration" value=30>
                            <div class="input-group-addon">minutes</div>
                            </div>
                        </div>
                    </div>
                    <div align="center">
                        <button type="button" class="btn btn-primary" onClick="addFlipClick()">Add this flip</button>
                    </div>
                </form>
                <div id="persistentNotifications"></div>
            </div>
            <div class="col-md-6">
                <h2>Flips</h2>
                <ul class="nav nav-tabs">
                    <li role="presentation" id="current" onClick="tabClick(this)" class="active"><a href="">Current</a></li>
                    <li role="presentation" id="all" onClick="tabClick(this)"><a href="">All</a></li>
                    <li role="presentation" id="archived" onClick="tabClick(this)"><a href="">Archived</a></li>
                </ul>
                <br>
                <div id="flipsPanels"></div> <!--optional style="max-height: 450px; overflow-y:auto;"-->           
            </div>
        </div>



    </div>
    <!-- /.container -->


    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="bootstrap-3.3.6-dist/js/jquery.1.11.3.min.js"></script>
    <script src="bootstrap-3.3.6-dist/js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="bootstrap-3.3.6-dist/js/ie10-viewport-bug-workaround.js"></script>

    <script src="selectize.js-master-0.12.1/dist/js/standalone/selectize.min.js"></script>
    
    <script src="bootstrap-notify-3.1.3/bootstrap-notify.min.js"></script>
    
    <script src="bootstrap-3.3.6-dist/js/bootbox.min.js"></script>

    <script>
        
        var itemValue;
        var itemName;
        
        $('#itemName').selectize({
            create: true,
            lockOptgroupOrder: true,
            onChange:function(value){
                $("#purchaseLimit").text("Purchase Limit: " + getItemBuyLimit(value))
            }
        });
        
        
        onload = function(){
            var flips = loadFlips();
            console.log(flips);
            var index = localStorage.getItem("index");
            if (index != null){
                for (i=1; i <= index; i++){
                    if (flips[i] != null){ //skip if this flip has been deleted and has no info.
                    displayFlip(flips[i], i); //otherwise display it.
                    }
                }
            }

            
            var txtBuyFor = document.getElementById('buyFor');
            txtBuyFor.oninput = recalculateMargins;
            txtBuyFor.onpropertychange = txtBuyFor.oninput; // for IE8
            // txtBuyFor.onchange = txtBuyFor.oninput; // FF needs this in <select><option>...
           
            var txtSellFor = document.getElementById('sellFor');
            txtSellFor.oninput = recalculateMargins;
            txtSellFor.onpropertychange = txtSellFor.oninput; // for IE8
            // txtSellFor.onchange = txtSellFor.oninput; // FF needs this in <select><option>...
            
            var txtQuantity = document.getElementById('quantity');
            txtQuantity.oninput = recalculateMargins;
            txtQuantity.onpropertychange = txtQuantity.oninput; // for IE8
            // txtSellFor.onchange = txtSellFor.oninput; // FF needs this in <select><option>...
        };
        
        function recalculateMargins() {
            var buy = $('#buyFor').val();
            var sell = $('#sellFor').val();
            var profit = sell-buy;
            $('#profit').text(profit + " gp");
            var quantity = $('#quantity').val();
            var totalCost = buy*quantity;
            var totalRevenue = sell*quantity;
            var totalProfit = profit*quantity;
            $('#cost').text(totalCost.toLocaleString() + " gp");
            $('#revenue').text(totalRevenue.toLocaleString() + " gp");
            $('#totalProfit').text(totalProfit.toLocaleString() + " gp");
        };
        
        //A list of items and their buy limits. A selectize can't store data- in itself, so we use this function instead,
        //and lookup the info via known itemAbbreviations.
        function getItemBuyLimit(value) {
            switch (value){
            //BLINE - Bandos Line
            case "bh": return "1/4";
            case "bcp": return "1/4";
            case "tass": return "1/4";
            case "bg": return "1/4";
            case "bb": return "1/4";
            case "bws": return "1/4";
            //ALINE - Armadyl Line
            case "ah": return "1/4";
            case "acp": return "1/4";
            case "acs": return "1/4";
            case "ag": return "1/4";
            case "ab": return "1/4";
            case "acb": return "1/4";
            case "oacb": return "1/4";
            case "buck": return "1/4";
            //SLINE - Subjugation Line
            case "sh": return "1/4";
            case "garb": return "1/4";
            case "gown": return "1/4";
            case "sg": return "1/4";
            case "sb": return "1/4";
            case "ward": return "1/4";
            //T LINE - Tetsu Line
            case "tth": return "2/4";
            case "ttb": return "2/4";
            case "ttl": return "2/4";
            //"DL LINE - Death Lotus Line
            case "blh": return "2/4";
            case "dlcp": return "2/4";
            case "dlc": return "2/4";
            // SS LINE - Seasinger's Line
            case "ssh": return "2/4";
            case "sst": return "2/4";
            case "ssb": return "2/4";
            //AMULETS - Amulets Line
            case "hiss": return "1/4";
            case "murm": return "1/4";
            case "whisp": return "1/4";
            //MISC LINE - Miscellaneous Line
            case "sss": return "1/4";
            case "rhh": return "2/4";
            case "rb": return "2/4";
            case "blood": return "2/4";
            //KITES - Kites Line
            case "male": return "1/4";
            case "merc": return "1/4";
            case "veng": return "1/4";
            default: return "Unknown";
            }
        }
        
        //Functions for storage and reading of flips _________________________________
        function addFlipClick() {
            toggleTabs("current"); //switch to view the current tab in case we're viewing a different one.
            
            var itemName = $('#itemName option:selected').text();
            var itemAbbreviation = $('#itemName option:selected').val();
            var itemBuyLimit = getItemBuyLimit(itemAbbreviation);
            var buy = $('#buyFor').val();
            var sell = $('#sellFor').val();
            var quantity = $('#quantity').val();
            var timestamp = new Date();
            var timerDuration = $('#timerDuration').val();
            var timerEnd = addMinutes(timestamp, timerDuration);
            var timesRuleAppliedBuy = 0;
            var timesRuleAppliedSell = 0;
            
            //ensure that all required fields are filled out.
            
            //create an object storing flip info.
            var flip = {itemName: itemName, itemAbbreviation: itemAbbreviation, itemBuyLimit: itemBuyLimit, buy: buy, sell: sell, quantity: quantity, timestamp: timestamp, timerDuration: timerDuration, timerEnd: timerEnd, timesRuleAppliedBuy: timesRuleAppliedBuy, timesRuleAppliedSell: timesRuleAppliedSell, buyCompleted: "no", sellCompleted: "no", archived: false};
            //stringify the object for storage inside of localStorage
            var stringFlip = JSON.stringify(flip);
            
            if(typeof(Storage) !== "undefined") {
                if (localStorage.getItem("index") == null) //if there isn't an index yet
                {
                    console.log("no index")
                    localStorage.setItem("index", "1"); //set up the index with an intital value
                    storeFlipInfo(stringFlip, "1");
                    clearNewFlipForm();
                    $.notify({message: "Flip added."},
                     {type: "success",
                     placement: 
                        {align: "center"}
                     });
                }
                else
                {
                    var currIndex = parseInt(localStorage.getItem("index")) + 1 //otherwise increment it's current value by 1
                    console.log("index of " + currIndex)
                    localStorage.setItem("index",currIndex);
                    storeFlipInfo(stringFlip, currIndex);
                    clearNewFlipForm();
                    $.notify({message: "Flip added."},
                     {type: "success",
                     placement: 
                        {align: "center"}
                     });
                }
            } else {
                alert("We can't store this info in localStorage, because your browser doesn't support it. Please, update to a modern browser to take advantage of Invert's full capabilities.")
            }
        }
         
        function storeFlipInfo(stringFlip, index) {
            console.log("storing in " + index);
            localStorage.setItem("f"+index,stringFlip);            
                        
            //clear old info, then write updated info
            $("#flipsPanels").html(""); 
            var flips = loadFlips();
            console.log(flips);
            var index = localStorage.getItem("index");
            if (index != null){
                for (i=1; i <= index; i++){
                    if (flips[i] != null){ //skip if this flip has been deleted and has no info.
                    displayFlip(flips[i], i); //otherwise display it.
                    }
                }
            }          
        }
        
        function clearNewFlipForm() {
            $('#itemName').selectize()[0].selectize.clear();//reset selectize
            $('#newFlipForm').trigger("reset"); //reset most other fields
            recalculateMargins() //adjust margins based on resetted form fields.
        }
        
        function loadFlips() {
            var index = localStorage.getItem("index");
            var arrayOfFlips = [];
            if (index != null){ //don't bother loading if there is no index set up. That means there shouldn't be any flips either.
                
                var foundAnArchivedFlip = false;
                var foundACurrentFlip = false;
                for (var i=1; i <= index; i++) {
                    arrayOfFlips[i] = getFlip(i); //parse the string back into an object.
                    if (getFlip(i) != null)
                    {
                        if (getFlip(i).archived == false){
                        foundACurrentFlip = true;
                        }
                        if (getFlip(i).archived == true){
                        foundAnArchivedFlip = true;
                        }    
                    }
                }
                //There are cases where no flips of certain types were found. These ifs are how we handle those cases.
                if (foundAnArchivedFlip == false && foundACurrentFlip == false){
                    $("#flipsPanels").append("<h3>It's lonely in here.</h3><p>It looks like you haven't created any flips yet.</p><p>Try adding a new one and it will be displayed in this area.</p>");
                }
                else
                    {
                    if (foundACurrentFlip == false) {
                        $("#flipsPanels").append("<span class=\"current currentNotification\"><h3>It's lonely in here.</h3><p>It looks like there aren't any current flips.</p><p>Try checking the \"All\" tab to see every flip in the system.</p></span>");
                    }
                    if (foundAnArchivedFlip == false){
                        $("#flipsPanels").append("<span class=\"archived archivedNotification\"><h3>It's lonely in here.</h3><p>It looks like there aren't any archived flips.</p><p>Try checking the \"All\" tab to see every flip in the system.</p></span>");
                    }        
                }
                return arrayOfFlips;
            }
            else{ //If i isn't set up there are no flips.
                $("#flipsPanels").append("<h3>It's lonely in here.</h3><p>It looks like you haven't created any flips yet.</p><p>Try adding a new one and it will be displayed in this area.</p>");
            }
            
        }
        
        function getFlip(index) { //for when you have the flip's number like "2"
            return JSON.parse(localStorage.getItem("f"+index));
        }
        
        function getFlipById(id){ //for when you have the flip's id like "f2"
            return JSON.parse(localStorage.getItem(id));
        }
        
        function formatPrice(price) {
            if (price < 1000) {
                return price + "gp";
            }
            else{
                return price.toString().slice(0, -3) + "k";
            }
        }

        function displayFlip(flip, index) {
            var html="";
            if (flip.archived == false){ //apply appropriate class
                if (flip.sellCompleted != "no")
                {
                    html += "<div id=\"f" + index +"\" class=\"panel panel-success current\" >";
                }
                else //flip is still pending.
                {
                    html += "<div id=\"f" + index +"\" class=\"panel panel-info current\" >";
                }       
            }
            else if (flip.archived == true)
            {
            html += "<div id=\"f" + index +"\" class=\"panel panel-default archived\" >";
            }
            html += "<div class=\"panel-heading\">";
            html += "<h3 class=\"panel-title\">" + flip.itemName +" <button class=\"btn btn-xs btn-danger pull-right\" onClick=\"btnDelete('f"+index+"')\"><span class=\"glyphicon glyphicon-trash\"><\/span>"
            html+= "<span class=\"hidden-xs\">&nbsp; Delete Flip</span>";
            html += "<\/button><\/h3>";
            html += "<\/div>";
            html += "<div class=\"panel-body\">";
            
            if (flip.buyCompleted == "no") //If the buying is not done.
            {
            html += "<p>Status: Currently buying this item.</p>"
                
            html += "<button class=\"btn btn-block btn-warning btnApplyRuleBuy\" data-id=\"f" + index + "\"><span class=\"glyphicon glyphicon-repeat pull-left\"><\/span>";
            html+= "<span class=\"hidden-xs\">Apply Rule (Buy for +25k gp, time +30 min)</span>";
            html+= "<span class=\"visible-xs\">Apply Rule (+25k, +30 min)</span>";
            html += "<\/button>";
            
            html += "<button class=\"btn btn-block btn-success btnInb\" data-id=\"f" + index + "\"><span class=\"glyphicon glyphicon-fire pull-left\"><\/span>";
            html+= "<span class=\"hidden-xs\">Buying Complete, Instant Buy</span>";
            html+= "<span class=\"visible-xs\">Instant Buy</span>";
            html += "<\/button>";
            
            html += "<button class=\"btn btn-block btn-success btnNib\" data-id=\"f" + index + "\"><span class=\"glyphicon glyphicon-ok pull-left\"><\/span>";
            html+= "<span class=\"hidden-xs\">Buying Complete, Non-Instant Buy</span>";
            html+= "<span class=\"visible-xs\">Non-Instant Buy</span>";
            html += "<\/button>";
            }

            if (flip.buyCompleted != "no" && flip.sellCompleted == "no") //If the buying is done, but the selling is not.
            {
            html += "<p>Status: Buying completed, currently selling this item.</p>"
            if (getItemBuyLimit(flip.itemAbbreviation) != "Unknown")
            {
                html += "<p>You can use the autogenerated text below to report your flip in the Flipchat1 Friends Chat channel.</p>"
            }
            else
            {
                html += "<p>This doesn't appear to be an item that Flipchat1 price checks. You shouldn't report it in the Friends Chat channel.</p>"
            }
                
            html += "<label>Buying Report:</label><textfield class=\"form-control\" rows=\"1\" onclick=\"this.select()\">"+flip.itemAbbreviation + " " + flip.buyCompleted + " @ " + formatPrice(flip.buy)
            if (flip.timesRuleAppliedBuy != 0){
            html += " rx" + flip.timesRuleAppliedBuy;
            }
            if (flip.buyCompleted == "nib")
            {
            html += " ?? minutes";
            }
            html += "</textfield><br>";
            
            html += "<button class=\"btn btn-block btn-warning btnApplyRuleSell\" data-id=\"f" + index + "\"><span class=\"glyphicon glyphicon-repeat pull-left\"><\/span>";
            html+= "<span class=\"hidden-xs\"> Apply Rule (Sell Price -25k, time +30min)</span>";
            html+= "<span class=\"visible-xs\">Apply Rule (-25k, +30 min)</span>";
            html += "<\/button>";
            
            html += "<button class=\"btn btn-block btn-success btnIns\" data-id=\"f" + index + "\"><span class=\"glyphicon glyphicon-fire pull-left\"><\/span>";
            html+= "<span class=\"hidden-xs\">Selling Complete, Instant Sell</span>";
            html+= "<span class=\"visible-xs\">Instant Sell</span>";
            html += "<\/button>";

            html += "<button class=\"btn btn-block btn-success btnNis\" data-id=\"f" + index + "\"><span class=\"glyphicon glyphicon-ok pull-left\"><\/span>";
            html+= "<span class=\"hidden-xs\">Selling Complete, Non-Instant Sell</span>";
            html+= "<span class=\"visible-xs\">Non-Instant Sell</span>";
            html += "<\/button>";
            }
            
            if (flip.sellCompleted != "no" && flip.archived == false) //If buying and selling is completed, but the flip isn't archived.
            {
            html += "<p>Status: Buying and selling completed!</p>"
            if (getItemBuyLimit(flip.itemAbbreviation) != "Unknown")
            {
                html += "<p>You can use the autogenerated text below to report your flip in the Flipchat1 Friends Chat channel.</p>"
            }
            else
            {
                html += "<p>This doesn't appear to be an item that Flipchat1 price checks. You shouldn't report it in the Friends Chat channel.</p>"
            }
            html += "<label>Buying Report:</label><textfield class=\"form-control\" rows=\"1\" onclick=\"this.select()\">"+flip.itemAbbreviation + " " + flip.buyCompleted + " @ " + formatPrice(flip.buy)
            if (flip.timesRuleAppliedBuy != 0){
            html += " rx" + flip.timesRuleAppliedBuy;
            }
            if (flip.buyCompleted == "nib")
            {
            html += " ?? minutes";
            }
            html += "</textfield><br>";
            html += "<label>Selling Report:</label><textfield class=\"form-control\" rows=\"1\" onclick=\"this.select()\">"+flip.itemAbbreviation + " " + flip.sellCompleted + " @ " + formatPrice(flip.sell)
            if (flip.timesRuleAppliedSell != 0){
            html += " rx" + flip.timesRuleAppliedSell;
            }
            if (flip.sellCompleted == "nis")
            {
            html += " ?? minutes";
            }
            html += "</textfield><br>";
                
            html += "<button class=\"btn btn-block btn-default btnArchive\" data-id=\"f" + index + "\"><span class=\"glyphicon glyphicon-floppy-disk pull-left\"><\/span>";
            html+= "<span class=\"hidden-xs\">Archive this Flip</span>";
            html+= "<span class=\"visible-xs\">Archive Flip</span>";
            html += "<\/button>";
            }
            
            if(flip.archived == true) //if the flip has been archived.
            {
            html += "<p>Status: Archived. (Buying and selling complete.)</p>"
            if (getItemBuyLimit(flip.itemAbbreviation) != "Unknown")
            {
                html += "<p>You can use the autogenerated text below to report your flip in the Flipchat1 Friends Chat channel.</p>"
            }
            else
            {
                html += "<p>This doesn't appear to be an item that Flipchat1 price checks. You shouldn't report it in the Friends Chat channel.</p>"
            }
            html += "<label>Buying Report:</label><textfield class=\"form-control\" rows=\"1\" onclick=\"this.select()\">"+flip.itemAbbreviation + " " + flip.buyCompleted + " @ " + formatPrice(flip.buy)
            if (flip.timesRuleAppliedBuy != 0){
            html += " rx" + flip.timesRuleAppliedBuy;
            }
            if (flip.buyCompleted == "nib")
            {
            html += " ?? minutes";
            }
            html += "</textfield><br>";
            html += "<label>Selling Report:</label><textfield class=\"form-control\" rows=\"1\" onclick=\"this.select()\">"+flip.itemAbbreviation + " " + flip.sellCompleted + " @ " + formatPrice(flip.sell)
            if (flip.timesRuleAppliedSell != 0){
            html += " rx" + flip.timesRuleAppliedSell;
            }
            if (flip.sellCompleted == "nis")
            {
            html += " ?? minutes";
            }
            html += "</textfield><br>";
            }
            
            html += "<\/div>";
            html += "<table class=\"table flipTable\">";
            html += "<tbody>";
            html += "<th scope=\"row\">Buying for<\/th>";
            html += "<td><div id=\"buyf"+index+"\">" + flip.buy + " gp</div><\/td>";
            html += "<td><button class=\"btn btn-xs btn-info btnBuyEdit pull-right\" data-id=\"f" + index + "\" type=\"button\"><span class=\"glyphicon glyphicon-pencil\"></span></button> <\/td>";

            html += "<\/tr>";
            html += "<tr>";
            html += "<th scope=\"row\">Selling for<\/th>";
            html += "<td>" + flip.sell + " gp<\/td>";
            html += "<td><button class=\"btn btn-xs btn-info btnSellEdit pull-right\" data-id=\"f" + index + "\" type=\"button\"><span class=\"glyphicon glyphicon-pencil\"></span></button> <\/td>";
            html += "<\/tr>";
            html += "<tr>";
            html += "<th scope=\"row\">Profit Per Item<\/th>";
            html += "<td>" + (flip.sell - flip.buy) + " gp<\/td>";
            html += "<td><\/td>";
            html += "<\/tr>";
            html += "<tr>";
            html += "<th scope=\"row\">Quantity<\/th>";
            html += "<td>" + flip.quantity + "<\/td>";
            html += "<td><button class=\"btn btn-xs btn-info btnQuantityEdit pull-right\" data-id=\"f" + index + "\" type=\"button\"><span class=\"glyphicon glyphicon-pencil\"></span></button> <\/td>";
            html += "<\/tr>";
            html += "<tr>";
            html += "<th scope=\"row\">Total Cost<\/th>";
            html += "<td>" + (flip.quantity * flip.buy)  + " gp<\/td>";
            html += "<td><\/td>";
            html += "<\/tr>";
            html += "<tr>";
            html += "<th scope=\"row\">Total Revenue<\/th>";
            html += "<td>" + (flip.quantity * flip.sell) + " gp<\/td>";
            html += "<td><\/td>";
            html += "<\/tr>";
            html += "<tr>";
            html += "<th scope=\"row\">Total Profit<\/th>";
            html += "<td>" + (flip.quantity * (flip.sell - flip.buy)) + " gp<\/td>";
            html += "<td><\/td>";
            html += "<\/tr>";
            html += "<tr>";
            html += "<th scope=\"row\">Timer<\/th>";
            html += "<td>"
            html += "<div id=\"clockdivf" + index + "\">";
            html += "  <div>";
            html += "    <span class=\"days\"><\/span>";
            html += "    <div class=\"smalltext\">Days<\/div>";
            html += "  <\/div>";
            html += "  <div>";
            html += "    <span class=\"hours\"><\/span>";
            html += "    <div class=\"smalltext\">Hours<\/div>";
            html += "  <\/div>";
            html += "  <div>";
            html += "    <span class=\"minutes\"><\/span>";
            html += "    <div class=\"smalltext\">Minutes<\/div>";
            html += "  <\/div>";
            html += "  <div>";
            html += "    <span class=\"seconds\"><\/span>";
            html += "    <div class=\"smalltext\">Seconds<\/div>";
            html += "  <\/div>";
            html += "<\/td>";
            html += "<td><button class=\"btn btn-xs btn-info btnAdd30min pull-right\" data-id=\"f" + index + "\" type=\"button\"><span class=\"glyphicon glyphicon-plus-sign\"></span> 30 min</button><\/td>";
            html += "<\/tr>";
            html += "<\/tbody>";
            html += "<\/table>";
            html += "<\/div>";
            //helpful tool for making strings out of html like this: http://www.accessify.com/tools-and-wizards/developer-tools/html-javascript-convertor/
            $("#flipsPanels").append(html);
            initializeClock('clockdivf' + index, flip.timerEnd);
        }
        
        // Timer related functions _______________________________________________
        function addMinutes(date, minutes) {
            console.log(date);
            console.log(minutes);
            return new Date(date.getTime() + minutes*60000);
        }
        
        //based on code here: http://www.sitepoint.com/build-javascript-countdown-timer-no-dependencies/
        function getTimeRemaining(endtime) {
          var t = Date.parse(endtime) - Date.parse(new Date());
          var seconds = Math.floor((t / 1000) % 60);
          var minutes = Math.floor((t / 1000 / 60) % 60);
          var hours = Math.floor((t / (1000 * 60 * 60)) % 24);
          var days = Math.floor(t / (1000 * 60 * 60 * 24));
          return {
            'total': t,
            'days': days,
            'hours': hours,
            'minutes': minutes,
            'seconds': seconds
          };
        }

        function initializeClock(id, endtime) {
          var clock = document.getElementById(id);
          var daysSpan = clock.querySelector('.days');
          var hoursSpan = clock.querySelector('.hours');
          var minutesSpan = clock.querySelector('.minutes');
          var secondsSpan = clock.querySelector('.seconds');

          function updateClock() {
            var t = getTimeRemaining(endtime);
              //console.log(t);
              //console.log(t.days);
              //console.log(t.hours);
              //console.log(t.minutes);
              //console.log(t.seconds);

            daysSpan.innerHTML = t.days;
            hoursSpan.innerHTML = ('0' + t.hours).slice(-2);
            minutesSpan.innerHTML = ('0' + t.minutes).slice(-2);
            secondsSpan.innerHTML = ('0' + t.seconds).slice(-2);

            if (t.total <= 0) {
                //clearInterval(timeinterval);
                timerEnded(id);
            }
          }

          updateClock();
          var timeinterval = setInterval(updateClock, 1000);
        }
        
        function timerEnded(id){
        console.log("The timer tied to " + id +" has ended.");
        }
        
        
        //CLICK HANDLERS for every single flip's buttons.
        function btnDelete(flipIndex){
            bootbox.dialog({
                closeButton: false,
                title: "Delete Flip",
                message: "Are you sure you wish to permanently delete this flip?",
                buttons: {
                    btnAbort:{
                        label: "No, cancel",
                    },
                    btnDelete:{
                        label: "Yes, delete forever",
                        className: "btn-danger",
                        callback: callback
                }
                }
            });
                    
            function  callback(){
                localStorage.removeItem(flipIndex);
                //clear old info, then write updated info
                $("#flipsPanels").html("");
                var flips = loadFlips();
                console.log(flips);
                var index = localStorage.getItem("index");
                if (index != null){
                    for (i=1; i <= index; i++){
                        if (flips[i] != null){ //skip if this flip has been deleted and has no info.
                        displayFlip(flips[i], i); //otherwise display it.
                        }
                    }
                }
                toggleTabs(findCurrentTab());
                $.notify({message: "Flip deleted."},
                         {type: "success",
                         placement: 
                            {align: "center"}
                         });
            }
        }
        
        $("#flipsPanels").on("click",".btnApplyRuleBuy",
            function(){
            //use the id to load the object for this flip.
            var thisflip = getFlipById($(this).data('id'));
            //update the values to what we want them to be.
            thisflip.buy = parseInt(thisflip.buy) + 25000;
            thisflip.timerDuration = parseInt(thisflip.timerDuration) + 30;
            thisflip.timerEnd = addMinutes(new Date(thisflip.timerEnd), 30);
            thisflip.timesRuleAppliedBuy = thisflip.timesRuleAppliedBuy + 1; 
            //stringify the object for storage inside of localStorage
            var stringFlip = JSON.stringify(thisflip);
            //write the flip back into localStorage
            storeFlipInfo(stringFlip, $(this).data('id').substr(1));
            
            toggleTabs(findCurrentTab());
            $.notify({message: "Rule applied, and flip updated."},
                     {type: "success",
                     placement: 
                        {align: "center"}
                     });
            });
        
        
        $("#flipsPanels").on("click",".btnInb",
            function(){
            //use the id to load the object for this flip.
            var thisflip = getFlipById($(this).data('id'));
            //update the values to what we want them to be.
            thisflip.buyCompleted = "inb";
            //stringify the object for storage inside of localStorage
            var stringFlip = JSON.stringify(thisflip);
            //write the flip back into localStorage
            storeFlipInfo(stringFlip, $(this).data('id').substr(1));
            
            toggleTabs(findCurrentTab());
            $.notify({message: "Buying marked as an Instant Buy, flip updated."},
                     {type: "success",
                     placement: 
                        {align: "center"}
                     });
            });
        
        $("#flipsPanels").on("click",".btnNib",
            function(){
            //use the id to load the object for this flip.
            var thisflip = getFlipById($(this).data('id'));
            //update the values to what we want them to be.
            thisflip.buyCompleted = "nib";
            //stringify the object for storage inside of localStorage
            var stringFlip = JSON.stringify(thisflip);
            //write the flip back into localStorage
            storeFlipInfo(stringFlip, $(this).data('id').substr(1));
            
            toggleTabs(findCurrentTab());
            $.notify({message: "Buying marked as a Non-Instant Buy, flip updated."},
                     {type: "success",
                     placement: 
                        {align: "center"}
                     });
            });
        
        $("#flipsPanels").on("click",".btnApplyRuleSell",
            function(){
            //use the id to load the object for this flip.
            var thisflip = getFlipById($(this).data('id'));
            //update the values to what we want them to be.
            thisflip.buy = parseInt(thisflip.buy) - 25000;
            thisflip.timerDuration = parseInt(thisflip.timerDuration) + 30;
            thisflip.timerEnd = addMinutes(new Date(thisflip.timerEnd), 30);
            thisflip.timesRuleAppliedSell = thisflip.timesRuleAppliedSell + 1; 
            //stringify the object for storage inside of localStorage
            var stringFlip = JSON.stringify(thisflip);
            //write the flip back into localStorage
            storeFlipInfo(stringFlip, $(this).data('id').substr(1));
            
            toggleTabs(findCurrentTab());
            $.notify({message: "Rule applied, and flip updated."},
                     {type: "success",
                     placement: 
                        {align: "center"}
                     });
            });     
        
        $("#flipsPanels").on("click",".btnIns",
            function(){
            //use the id to load the object for this flip.
            var thisflip = getFlipById($(this).data('id'));
            //update the values to what we want them to be.
            thisflip.sellCompleted = "ins";
            //stringify the object for storage inside of localStorage
            var stringFlip = JSON.stringify(thisflip);
            //write the flip back into localStorage
            storeFlipInfo(stringFlip, $(this).data('id').substr(1));
            
            toggleTabs(findCurrentTab());
            $.notify({message: "Selling marked as an Instant Sell, flip updated."},
                     {type: "success",
                     placement: 
                        {align: "center"}
                     });
            });
        
        $("#flipsPanels").on("click",".btnNis",
            function(){
            //use the id to load the object for this flip.
            var thisflip = getFlipById($(this).data('id'));
            //update the values to what we want them to be.
            thisflip.sellCompleted = "nis";
            //stringify the object for storage inside of localStorage
            var stringFlip = JSON.stringify(thisflip);
            //write the flip back into localStorage
            storeFlipInfo(stringFlip, $(this).data('id').substr(1));
            
            toggleTabs(findCurrentTab());
            $.notify({message: "Selling marked as a Non-Instant Sell, flip updated."},
                     {type: "success",
                     placement: 
                        {align: "center"}
                     });
            });
        
        $("#flipsPanels").on("click",".btnArchive",
            function(){
            //use the id to load the object for this flip.
            var thisflip = getFlipById($(this).data('id'));
            //update the values to what we want them to be.
            thisflip.archived = true;
            //stringify the object for storage inside of localStorage
            var stringFlip = JSON.stringify(thisflip);
            //write the flip back into localStorage
            storeFlipInfo(stringFlip, $(this).data('id').substr(1));
            
            toggleTabs(findCurrentTab());
            $.notify({message: "Flip archived."},
                     {type: "success",
                     placement: 
                        {align: "center"}
                     });
            });
        
        $("#flipsPanels").on("click",".btnBuyEdit",
            function(){
                var flipId = $(this).data('id');            
                makeAreaEditable("buy", flipId);
                //Change the buy button into a save button.
                console.log(this)
                $(this).removeClass("btnBuyEdit");
                $(this).addClass("btnBuySave");
                $(this).html('<span class="glyphicon glyphicon-floppy-disk"></span>');
            });
        
        $("#flipsPanels").on("click",".btnBuySave",
            function(){
                var flipId = $(this).data('id');            
                saveEdit("buy", flipId);
            });
        
        function makeAreaEditable(type, flipId)
        {
            var text = $("#"+type+flipId).html();
            var editableArea = $("#"+type+flipId);
            editableArea.replaceWith('<textfield class="form-control" id="'+type+flipId+'">'+text+'</textfield>');
            
        };														


        function saveEdit()
        {
            var target = event.target || event.srcElement || event.originalTarget;
            var button = $("#"+target.id);
            var textarea = $(this).parent().find('textarea');
            var text = textarea.val();
            button.text("edit");
            button.unbind('click');
            button.bind('click',makeAreaEditable);
            var targetArea = button.parent().find('textarea');
            var textid = target.name;
            targetArea.replaceWith("<li id='"+textid+"' style='list-style-type:none;'>"+text+"</li>");
        };
        
        $("#flipsPanels").on("click",".btnSellEdit",
            function(){
                console.log($(this).data('id'));
                console.log("seal!");
            });
        
        $("#flipsPanels").on("click",".btnQuantityEdit",
            function(){
                console.log($(this).data('id'));
                console.log("qwan!");
            });
        
        $("#flipsPanels").on("click",".btnAdd30min",
            function(){
                console.log($(this).data('id'));
                console.log("30min!");
            });
        
        // END CLICK HANDLERS
        
        
        //Functions to handle display of current/archived flips in tabs.
        //Technically we just show/hide flips depending on the tab clicked
        function tabClick(caller){
            event.preventDefault(); 
            toggleTabs(caller.id);
        }
        
        function findCurrentTab(){
            if ($("#current").hasClass("active")){
                return "current";
            }
            else if($("#all").hasClass("active")){
                return "all";
            }
            else if ($("#archived").hasClass("active")){
                return "archived";
            }
        }
        
        function toggleTabs(tabToToggle){
            $("#" + tabToToggle).toggleClass("active");

            if (tabToToggle == "current")
            {
                $("#current").toggleClass("active", true);
                $("#all").toggleClass("active", false);
                $("#archived").toggleClass("active", false);
                
                $(".current").toggle(true);
                $(".archived").toggle(false);
            }
            else if (tabToToggle == "all")
            {
                $("#current").toggleClass("active", false);
                $("#all").toggleClass("active", true);
                $("#archived").toggleClass("active", false);
                
                $(".current").toggle(true);
                $(".archived").toggle(true);
                $("span.archivedNotification").toggle(false);
                $("span.currentNotification").toggle(false);
            }
            else if (tabToToggle == "archived")
            {
                $("#current").toggleClass("active", false);
                $("#all").toggleClass("active", false);
                $("#archived").toggleClass("active", true);
                
                $(".current").toggle(false);
                $(".archived").toggle(true);
            }
        }
            
          
    </script>
</body>

</html>